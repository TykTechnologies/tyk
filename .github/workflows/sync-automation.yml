

# Generated by: tyk-ci/wf-gen
# Generated on: Friday 22 April 2022 08:10:05 AM UTC

# Generation commands:
# ./meta.zsh -repos tyk,tyk-analytics -base master -branch fix/td-983/update-sync-automation -title Remove release-4-lt from sync automation targets. -p
# m4 -E -DxSRC_BRANCH='master' -DxRELEASE_BRANCHES='release-3.2.3, release-4' -DxAUTO_FILES='ci .github/workflows/release.yml .github/dependabot.yml .github/workflows/del-env.yml .github/workflows/api-tests.yml .github/workflows/ui-tests.yml'

# This workflow will silently ignore FILES that are missing in master
# Most of the time this is what we want, older repos may not have some files

name: Sync automation

on:
  push:
    branches:
      - master
    paths:
      - .github/workflows/release.yml
      - .github/workflows/api-tests.yml
      - .github/workflows/ui-tests.yml
      - ci/**

jobs:
  sync:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        branch: [ release-3.2.3, release-4 ]

    steps:
      - uses: actions/checkout@v2
        with:
          ref: ${{matrix.branch}}
          token: ${{ secrets.ORG_GH_TOKEN }}

      - name: sync ${{matrix.branch}} from master
        id: sync-changes
        run: |
          git fetch origin master
          git config --local user.email "wf-gen@tyk-ci"
          git config --local user.name "Bender"
          if git rebase --onto ${{ matrix.branch }} master ${{ github.sha }}; then
            echo "::set-output name=status::success"
            echo "::notice::Rebase Success"
          else
            echo "::set-output name=status::fail"
            echo "::notice::Rebase Failed->Conflicts!"
            exit 1
          fi
          prbranch=sync/auto/${{ matrix.branch }}-${{ github.run_id }}
          git switch -c $prbranch
          git push origin $prbranch
          echo "::set-output name=prbranch::$prbranch"
          echo "::debug::Commit ${{ github.sha }} syncd for ${{matrix.branch}}"
          exit 0

      - name: Create PR from the branch.
        id: create-pr
        if: steps.sync-changes.outputs.status == 'success'
        uses: actions/github-script@v6
        with:
          script: |
            const response = await github.rest.pulls.create({
              title: '[CI] Sync automation: Syncing commits from master',
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: ${{ steps.sync-changes.outputs.prbranch }},
              base: ${{ matrix.branch }},
              body: ` PR auto generated by the CI Sync automation.
                      Picks the commit ${{ github.sha }} from master
                      Please make any additional changes required before
                      merging. `});
            github.rest.issues.addLabels({
              owner:  context.repo.owner,
              repo: context.repo.repo,
              issue_number: response.data.number,
              labels: ['sync-automation'] });

      - name: Notify slack on conflicts.
        if: steps.sync-changes.outputs.status == 'fail'
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_TITLE: 'Sync-automation'
          SLACK_MESSAGE: 'Conflicts while syncing automation, commit: ${{ github.sha }}, branch: ${{ matrix.branch }}'
          SLACK_WEBHOOK: ${{ secrets.SYNC_NOTIFY_SLACK_HOOK }}
