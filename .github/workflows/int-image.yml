# Generated by: pr.zsh from tyk-ci/wf-gen
# Generated on: Fri 11 Dec 00:35:46 IST 2020

name: tyk image

on:
  push:
    branches:
      - master
      - integration/*
      - feature/*
      - release-**

jobs:
  tyk:
    runs-on: ubuntu-latest
    container: tykio/tyk-build-env:ga

    steps:
      - name: checkout tyk
        uses: actions/checkout@v2

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v1
        with:
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}
          terraform_wrapper: false
            
      - name: Get AWS creds from Terraform remote state
        id: aws-creds
        run: |
            cd integration/terraform
            terraform init -input=false -lock=false
            terraform refresh
            eval $(terraform output -json tyk | jq -r 'to_entries[] | [.key,.value] | join("=")')
            region=$(terraform output region | xargs)
            [ -z "$key" -o -z "$secret" -o -z "$region" -o -z "$ecr" ] && exit 1
            echo "::set-output name=secret::$secret"
            echo "::add-mask::$secret"
            echo "::set-output name=key::$key"
            echo "::set-output name=ecr::$ecr"
            echo "::set-output name=region::$region"
      
      - name: Configure AWS credentials for use
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ steps.aws-creds.outputs.key }}
          aws-secret-access-key: ${{ steps.aws-creds.outputs.secret }}
          aws-region: ${{ steps.aws-creds.outputs.region }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      - name: Build release tarball
        run: |
            if [ -x bin/integration_build.sh ]; then
               SIGNPKGS=0 BUILDPKGS=0 BUILDWEB=0 ARCH=amd64 bin/integration_build.sh
               cp tyk-amd64-*.tar.gz integration/image/tyk.tar.gz
            fi

      - name: Build, tag, and push image to Amazon ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: tyk
        run: |
            cd integration/image
            IMAGE_TAG="${GITHUB_REF##*/}"
            docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
                         -t $ECR_REGISTRY/$ECR_REPOSITORY:latest \
                         -t $ECR_REGISTRY/$ECR_REPOSITORY:${GITHUB_SHA} \
                         .
            docker push $ECR_REGISTRY/$ECR_REPOSITORY

      - name: Tell gromit about new build
        run: |
            curl -fsSL -H "Authorization: ${{secrets.GROMIT_TOKEN}}" 'https://domu-kun.cloud.tyk.io/gromit/newbuild' \
                 -X POST -d '{ "repo": "${{ github.repository}}", "ref": "${{ github.ref }}", "sha": "${{ github.sha }}" }'

      - name: Logout of Amazon ECR
        if: always()
        run: docker logout ${{ steps.login-ecr.outputs.registry }}
