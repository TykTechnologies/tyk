sudo: required
language: go

notifications:
  on_success: never
  on_failure: always

env:
  global:
    - TYK_LOGLEVEL=info
    - CONSUL_VERSION=1.4.4
    - CONSUL_DIR=$HOME/consul_$CONSUL_VERSION

addons:
  apt:
    packages:
    - python3.5
    - python3-pip
    - libluajit-5.1-dev

matrix:
  include:
    - go: 1.10.x
    - go: 1.11.x
      env: LATEST_GO=true # run linters and report coverage


services:
  - redis-server

install:
  - go get
  - go install ./...
    # As of 1.9, ./... no longer includes ./vendor/...
  - go install ./vendor/{golang.org/x/tools/cmd/goimports,github.com/wadey/gocovmerge,github.com/mattn/goveralls}

before_script:
  - 'if [[ ! -f $CONSUL_DIR/consul ]]; then (mkdir -p $CONSUL_DIR && cd $CONSUL_DIR && wget https://releases.hashicorp.com/consul/${CONSUL_VERSION}_linux_amd64.zip && unzip ${CONSUL_VERSION}_linux_amd64.zip); fi'
  - $CONSUL_DIR/consul --version
  - $CONSUL_DIR/consul agent --dev &
  # Wait for consul's raft election
  - sleep 5

script:
  - sudo pip3 install google
  - sudo pip3 install protobuf
  - go build -tags 'coprocess python'
  - go build -tags 'coprocess lua'
  - go build -tags 'coprocess grpc'
  - ./utils/ci-test.sh
  - if [[ $LATEST_GO ]]; then goveralls -coverprofile=<(gocovmerge *.cov); fi
  - ./utils/ci-benchmark.sh
